---
- name : install docker
  hosts : all
  vars:
    create_containers: 4
    default_container_name: docker
    default_container_image: centos
    default_container_command: sleep 1d

  tasks:
  - name: update packages
    apt:
     update_cache: yes

  - name: install packages
    apt:
     name: "{{ packages }}"
     update_cache: yes
     state: latest
    vars:
     packages:
      - apt-transport-https
      - ca-certificates
      - software-properties-common
      - curl
      - python-pip

  - name: ajouter la clé GPG du site de Docker
    apt_key:
      url: https://download.docker.com/linux/debian/gpg
      state: present

  - name: Pointer vers le dépôt de la version "stable" de Docker
    apt_repository:
      repo: deb [arch=amd64] https://download.docker.com/linux/debian stretch stable
      state: present

  - name: install docker
    apt:
      name: "docker-ce"
      state: latest

  - name: install python modules (for older versions of OS)
    pip: 
      name: "{{ item }}"
      state: present
    with_items:
     - urllib3
     - pyOpenSSL
     - ndg-httpsclient
     - pyasn1
  
  - name : install python-docker
    apt:
     name: python-docker
     update_cache: yes

  - name: pull d'une image
    docker_image:
      name: "{{ default_container_image }}"
      source: pull

  - name: creation contenaire
    docker_container:
      name: "{{ default_container_name }}{{ item }}"
      image: "{{ default_container_image }}"
      command: "{{ default_container_command }}"
    with_sequence: count={{ create_containers }}
